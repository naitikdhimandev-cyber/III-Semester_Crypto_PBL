<!DOCTYPE html>
<html>
<head>
    <title>PBL Blockchain</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, button { padding: 5px; margin: 5px; }
        .block { border: 1px solid #333; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <div>
            <h1>PBL Blockchain</h1>
            {% if username %}
                <p>Welcome back, <strong>{{ username }}</strong>!</p>
            {% endif %}
        </div>
        <div style="text-align: right;">
            <a href="{{ url_for('index') }}" style="margin-right: 15px; text-decoration: none; color: #2c3e50;">Dashboard</a>
            <a href="{{ url_for('view_messages') }}" style="margin-right: 15px; text-decoration: none; color: #2c3e50;">My Messages</a>
            <a href="{{ url_for('blockchain_explorer') }}" style="margin-right: 15px; text-decoration: none; color: #2c3e50;">Blockchain Explorer</a>
            <a href="{{ url_for('status') }}" style="text-decoration: none; color: #2ecc71; font-weight: bold;">Node Status</a>
            <br>
            <a href="{{ url_for('logout') }}" style="margin-top: 5px; display: inline-block; color: #e74c3c; text-decoration: none;">Logout</a>
        </div>
    </div>
    
    <div style="float: right; width: 300px; margin: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h3>Send Encrypted Message</h3>
        <form id="messageForm" style="display: flex; flex-direction: column; gap: 10px;">
            <div>
                <label for="receiver_id">Receiver ID:</label>
                <input type="number" id="receiver_id" name="receiver_id" required style="width: 100%;">
            </div>
            <div>
                <label for="message">Message:</label>
                <textarea id="message" name="message" required style="width: 100%; height: 100px;"></textarea>
            </div>
            <button type="submit" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Send Message
            </button>
        </form>
    </div>

    <h2>Add New Block</h2>
    <form id="blockForm">
        <input type="text" id="cipher_text" placeholder="Cipher Text" required>
        <input type="text" id="encrypted_key" placeholder="Encrypted AES Key" required>
        <button type="submit">Add Block</button>
    </form>

    <h2>Blockchain</h2>
    <div id="chain"></div>

    <script>
        async function fetchChain() {
            const res = await fetch('/chain');
            const chain = await res.json();
            const chainDiv = document.getElementById('chain');
            chainDiv.innerHTML = '';
            chain.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'block';
                blockDiv.innerHTML = `
                    <strong>Index:</strong> ${block.index}<br>
                    <strong>Cipher:</strong> ${block.data.cipher_text.length > 60 
                                                    ? block.data.cipher_text.substring(0, 60) + '...' 
                                                    : block.data.cipher_text}<br>
                    <strong>Encrypted Key:</strong> ${block.data.key_text.length > 60 
                                                    ? block.data.key_text.substring(0, 60) + '...' 
                                                    : block.data.key_text}<br>
                    <strong>Prev Hash:</strong> ${block.previous_hash.substring(0, 50)}...<br>
                    <strong>Hash:</strong> ${block.hash.substring(0, 50)}...
                `;
                chainDiv.appendChild(blockDiv);
            });
        }

        // Handle message form submission
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                receiver_id: formData.get('receiver_id'),
                message: formData.get('message')
            };

            try {
                const response = await fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('Message sent successfully!');
                    e.target.reset();
                } else {
                    alert('Error: ' + (result.error || 'Failed to send message'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        });

        document.getElementById('blockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cipher_text = document.getElementById('cipher_text').value;
            const encrypted_key = document.getElementById('encrypted_key').value;

            await fetch('/add_block', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `cipher_text=${cipher_text}&encrypted_key=${encrypted_key}`
            });

            document.getElementById('cipher_text').value = '';
            document.getElementById('encrypted_key').value = '';
            fetchChain();
        });

        fetchChain();  
    </script>
</body>
</html>
